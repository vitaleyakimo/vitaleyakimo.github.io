<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</title>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }
    .status-pending { color: #d9a700; }
    .status-confirmed { color: #52c41a; }
    .status-expired { color: #ff4d4f; }
    button { margin: 0.25rem; padding: 0.3rem 0.6rem; cursor: pointer; }
    .actions { white-space: nowrap; }
    .cleanup { background: #fff1f0; padding: 1rem; margin: 1rem 0; }
  </style>
</head>
<body>
  <h1>–ê–¥–º–∏–Ω–∫–∞: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏</h1>

  <div class="cleanup">
    <p><strong>–û—á–∏—Å—Ç–∫–∞ –∞—Ä—Ö–∏–≤–∞:</strong> –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –¥–æ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ —á–∏—Å–ª–∞ (–¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã).</p>
    <button onclick="cleanupOldBookings()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏</button>
    <span id="cleanup-result"></span>
  </div>

  <div>
    <label>–ü–∞—Ä–æ–ª—å: <input type="password" id="admin-pass" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" /></label>
    <button onclick="loadBookings()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
  </div>

  <div id="bookings-list"></div>

  <script>
    // üîë –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô URL!
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJCQhvgSpM9uTzlX_mD0plJOZfS5vxOiPjKqXLMHGQ_Gulebmi93_1NGX53sPh0_gp/exec';

    async function loadBookings() {
      const pass = document.getElementById('admin-pass').value;
      if (!pass) { alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'); return; }

      try {
        const res = await fetch(`${SCRIPT_URL}?admin=${encodeURIComponent(pass)}`);
        const data = await res.json();

        if (!data || data.success === false) {
          document.getElementById('bookings-list').innerHTML = `<p style="color:red">‚ùå ${data.error || '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞'}</p>`;
          return;
        }

        if (data.length === 0) {
          document.getElementById('bookings-list').innerHTML = '<p>–ù–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.</p>';
          return;
        }

        let html = `<table>
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–í—Ä–µ–º—è</th>
              <th>–ò–º—è</th>
              <th>–ö–æ–Ω—Ç–∞–∫—Ç</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>`;

        data.forEach(b => {
          const statusClass = `status-${b.status}`;
          html += `
            <tr>
              <td>${b.date}</td>
              <td>${b.start}‚Äì${b.end}</td>
              <td>${b.name}</td>
              <td>${b.contact}</td>
              <td class="${statusClass}">${b.status}</td>
              <td class="actions">
                ${b.status !== 'confirmed' ? 
                  `<button onclick="confirmBooking('${b.id}', '${pass}')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>` : ''}
                <button onclick="deleteBooking('${b.id}', '${pass}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              </td>
            </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('bookings-list').innerHTML = html;
      } catch (e) {
        console.error(e);
        document.getElementById('bookings-list').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>';
      }
    }

    async function confirmBooking(id, pass) {
      await sendAdminAction(pass, 'confirm', id);
      loadBookings();
    }

    async function deleteBooking(id, pass) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) return;
      await sendAdminAction(pass, 'delete', id);
      loadBookings();
    }

    async function sendAdminAction(password, action, id) {
      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ admin: true, password, action, id })
        });
      } catch (e) { console.error(e); }
    }

    async function cleanupOldBookings() {
      const pass = document.getElementById('admin-pass').value;
      if (!pass) { alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'); return; }

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ admin: true, password: pass, action: "cleanup" })
      });
      const result = await res.json();

      const el = document.getElementById('cleanup-result');
      if (result.success) {
        el.innerHTML = `‚úÖ –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.deleted}`;
      } else {
        el.innerHTML = `‚ùå ${result.error}`;
      }
    }
  </script>
</body>
</html>