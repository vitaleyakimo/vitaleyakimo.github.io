<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è | –í–∏—Ç–∞–ª–µ –Ø–∫–∏–º–æ</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: 2rem auto; padding: 0 1rem; background: #fff; }
    .container { padding: 1.5rem; }
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    th, td { border: 1px solid #ddd; padding: 0.75rem; text-align: left; }
    .status-pending { color: #d9a700; }
    .status-confirmed { color: #52c41a; }
    .status-expired { color: #ff4d4f; }
    button { margin: 0.25rem; padding: 0.4rem 0.8rem; cursor: pointer; border: none; border-radius: 4px; }
    .btn-confirm { background: #e6f7ff; color: #1890ff; }
    .btn-delete { background: #fff1f0; color: #ff4d4f; }
    .cleanup { background: #f9f9f9; padding: 1rem; margin: 1.5rem 0; border-radius: 6px; }
    input[type="password"] { padding: 0.5rem; margin-right: 0.5rem; width: 200px; }
  </style>
</head>
<body>
  <header class="hero" role="banner">
    <div class="overlay"></div>
    <div class="hero-content">
      <h1>–ê–¥–º–∏–Ω–∫–∞: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h1>
      <div class="hero-nav">
        <a href="/" class="hero-nav-link">–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</a>
        <a href="/booking.html" class="hero-nav-link">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</a>
        <a href="/admin.html" class="hero-nav-link">–ê–¥–º–∏–Ω–∫–∞</a>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="cleanup">
      <p><strong>–û—á–∏—Å—Ç–∫–∞ –∞—Ä—Ö–∏–≤–∞:</strong> –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –¥–æ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ —á–∏—Å–ª–∞.</p>
      <input type="password" id="cleanup-pass" placeholder="–ü–∞—Ä–æ–ª—å" />
      <button onclick="cleanupOldBookings()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏</button>
      <span id="cleanup-result"></span>
    </div>

    <div>
      <input type="password" id="admin-pass" placeholder="–ü–∞—Ä–æ–ª—å" />
      <button onclick="loadBookings()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
    </div>

    <div id="bookings-list"></div>
  </main>

  <footer role="contentinfo">
    <p>&copy; 2025 –í–∏—Ç–∞–ª–µ –Ø–∫–∏–º–æ. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </footer>

  <script>
    // üîë –£–∫–∞–∂–∏—Ç–µ –≤–∞—à –†–ê–ë–û–ß–ò–ô URL –∏–∑ Apps Script (—Ç–æ—Ç –∂–µ, —á—Ç–æ –∏ –≤ booking.html)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxNHFp8Ke1UaGToJJIOLpN1DqpuqDIAbLbd0fRzrf-A8FMiMVXpCq72OHeFC-oqyzjX1w/exec';

    async function loadBookings() {
      const pass = document.getElementById('admin-pass').value;
      if (!pass) { alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'); return; }

      try {
        const url = `${SCRIPT_URL}?admin=${encodeURIComponent(pass)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data || data.success === false) {
          document.getElementById('bookings-list').innerHTML = `<p style="color:red">‚ùå ${data.error || '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞'}</p>`;
          return;
        }

        if (data.length === 0) {
          document.getElementById('bookings-list').innerHTML = '<p>–ù–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.</p>';
          return;
        }

        let html = `<table>
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–í—Ä–µ–º—è</th>
              <th>–ò–º—è</th>
              <th>–ö–æ–Ω—Ç–∞–∫—Ç</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>`;

        data.forEach(b => {
          const statusClass = `status-${b.status}`;
          html += `
            <tr>
              <td>${b.date}</td>
              <td>${b.start}‚Äì${b.end}</td>
              <td>${b.name}</td>
              <td>${b.contact}</td>
              <td class="${statusClass}">${b.status}</td>
              <td>
                ${b.status !== 'confirmed' ? 
                  `<button class="btn-confirm" onclick="confirmBooking('${b.id}', '${pass}')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>` : ''}
                <button class="btn-delete" onclick="deleteBooking('${b.id}', '${pass}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              </td>
            </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('bookings-list').innerHTML = html;
      } catch (e) {
        console.error(e);
        document.getElementById('bookings-list').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>';
      }
    }

    // === –û–¢–ü–†–ê–í–ö–ê –ë–ï–ó JSON, –¢–û–õ–¨–ö–û form-urlencoded ===
    async function sendAdminAction(password, action, id) {
      const formData = new URLSearchParams();
      formData.append('admin', 'true');
      formData.append('password', password);
      formData.append('action', action);
      if (id) formData.append('id', id);

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData  // ‚Üê –±–µ–∑ headers!
        });
        const result = await res.json();
        if (!result.success) {
          alert('–û—à–∏–±–∫–∞: ' + (result.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
        }
        return result;
      } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
        throw e;
      }
    }

    async function confirmBooking(id, pass) {
      await sendAdminAction(pass, 'confirm', id);
      loadBookings();
    }

    async function deleteBooking(id, pass) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) return;
      await sendAdminAction(pass, 'delete', id);
      loadBookings();
    }

    async function cleanupOldBookings() {
      const pass = document.getElementById('cleanup-pass').value;
      if (!pass) { alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'); return; }

      const formData = new URLSearchParams();
      formData.append('admin', 'true');
      formData.append('password', pass);
      formData.append('action', 'cleanup');

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
        const result = await res.json();
        const el = document.getElementById('cleanup-result');
        if (result.success) {
          el.innerHTML = `‚úÖ –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.deleted}`;
        } else {
          el.innerHTML = `‚ùå ${result.error || '–û—à–∏–±–∫–∞'}`;
        }
      } catch (e) {
        console.error(e);
        document.getElementById('cleanup-result').innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
      }
    }
  </script>
</body>
</html>